/*
 * سرور بک‌اند ساده برای برنامه مترو تبریز
 * فاز ۱: جداسازی داده‌ها از فرانت‌اند
 */

const express = require('express');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// فعال‌سازی CORS برای اجازه دادن به فرانت‌اند (که روی پورت دیگری است)
// تا بتواند از این API درخواست کند.
app.use(cors());

// =====================================================================
// ||                    داده‌ها و منطق برنامه مترو                    ||
// =====================================================================
// در یک پروژه واقعی‌تر، این داده‌ها از یک دیتابیس یا فایل‌های CSV خوانده می‌شوند.
// اما برای فاز ۱، ما همان منطق `metroDataManager` را به سرور منتقل می‌کنیم
// تا فرانت‌اند کاملاً از داده‌ها جدا شود.

const metroDataManager = {
    metroData: {},
    stationNames: [
        "ائل گؤلی", "سهند", "امام رضا(ع)", "خیام", "29بهمن", "استاد شهریار",
        "دانشگاه", "آبرسان", "سالار ملی(قطب)", "شهید بهشتی (ره)", "میدان ساعت",
        "میدان کهن", "قونقا", "گازران", "لاله", "امام حسین(ع)", "شهید باکری", "نور"
    ],

    // داده‌های روزهای عادی
    elGoliToNoor_Normal: [
        "05:55:00", "06:10:00", "06:25:00", "06:40:00", "06:55:00", "07:10:00", "07:25:00", "07:40:00", "07:55:00", "08:10:00", "08:25:00", "08:40:00", "08:55:00", "09:10:00", "09:25:00", "09:40:00", "09:55:00", "10:10:00", "10:25:00", "10:40:00", "10:55:00", "11:10:00", "11:25:00", "11:40:00", "11:55:00", "12:10:00", "12:25:00", "12:40:00", "12:55:00", "13:10:00", "13:25:00", "13:40:00", "13:55:00", "14:10:00", "14:25:00", "14:40:00", "14:55:00", "15:10:00", "15:25:00", "15:40:00", "15:55:00", "16:10:00", "16:25:00", "16:40:00", "16:55:00", "17:10:00", "17:25:00", "17:40:00", "17:55:00", "18:10:00", "18:25:00", "18:40:00", "18:55:00", "19:10:00", "19:25:00", "19:40:00", "19:55:00", "20:10:00"
    ],
    noorToElGoli_Normal: [
        "06:50:00", "07:05:00", "07:20:00", "07:35:00", "07:50:00", "08:05:00", "08:20:00", "08:35:00", "08:50:00", "09:05:00", "09:20:00", "09:35:00", "09:50:00", "10:05:00", "10:20:00", "10:35:00", "10:50:00", "11:05:00", "11:20:00", "11:35:00", "11:50:00", "12:05:00", "12:20:00", "12:35:00", "12:50:00", "13:05:00", "13:20:00", "13:35:00", "13:50:00", "14:05:00", "14:20:00", "14:35:00", "14:50:00", "15:05:00", "15:20:00", "15:35:00", "15:50:00", "16:05:00", "16:20:00", "16:35:00", "16:50:00", "17:05:00", "17:20:00", "17:35:00", "17:50:00", "18:05:00", "18:20:00", "18:35:00", "18:50:00", "19:05:00", "19:20:00", "19:35:00", "19:50:00", "20:05:00", "20:20:00", "20:35:00", "20:50:00"
    ],

    // داده‌های روزهای تعطیل
    elGoliToNoor_Holiday: [
        "07:30:00", "07:46:00", "08:02:00", "08:18:00", "08:34:00", "08:50:00", "09:06:00", "09:22:00", "09:38:00", "09:54:00", "10:10:00", "10:26:00", "10:42:00", "10:58:00", "11:14:00", "11:30:00", "11:46:00", "12:02:00", "12:18:00", "12:34:00", "12:50:00", "13:06:00", "13:22:00", "13:38:00", "13:54:00", "14:10:00", "14:26:00", "14:42:00", "14:58:00", "15:14:00", "15:30:00", "15:46:00", "16:02:00", "16:18:00", "16:34:00", "16:50:00", "17:06:00", "17:22:00", "17:38:00", "17:54:00", "18:10:00", "18:26:00", "18:42:00", "18:58:00", "19:14:00", "19:30:00", "19:46:00"
    ],
    noorToElGoli_Holiday: [
        "08:15:00", "08:31:00", "08:47:00", "09:03:00", "09:19:00", "09:35:00", "09:51:00", "10:07:00", "10:23:00", "10:39:00", "10:55:00", "11:11:00", "11:27:00", "11:43:00", "11:59:00", "12:15:00", "12:31:00", "12:47:00", "13:03:00", "13:19:00", "13:35:00", "13:51:00", "14:07:00", "14:23:00", "14:39:00", "14:55:00", "15:11:00", "15:27:00", "15:43:00", "15:59:00", "16:15:00", "16:31:00", "16:47:00", "17:03:00", "17:19:00", "17:35:00", "17:51:00", "18:07:00", "18:23:00", "18:39:00", "18:55:00", "19:11:00", "19:27:00", "19:43:00", "19:59:00", "20:15:00"
    ],

    // زمان‌های تقریبی سفر بین ایستگاه‌ها (به ثانیه)
    // این داده‌ها بر اساس فایل اکسل شما استخراج شده‌اند
    stationTravelTimes: [
        0, // ائل گؤلی
        120, // سهند (2 دقیقه)
        120, // امام رضا (2 دقیقه)
        120, // خیام (2 دقیقه)
        120, // 29بهمن (2 دقیقه)
        120, // استاد شهریار (2 دقیقه)
        120, // دانشگاه (2 دقیقه)
        120, // آبرسان (2 دقیقه)
        120, // سالار ملی (2 دقیقه)
        120, // شهید بهشتی (2 دقیقه)
        120, // میدان ساعت (2 دقیقه)
        180, // میدان کهن (3 دقیقه)
        120, // قونقا (2 دقیقه)
        120, // گازران (2 دقیقه)
        120, // لاله (2 دقیقه)
        120, // امام حسین (2 دقیقه)
        120, // شهید باکری (2 دقیقه)
        120  // نور (2 دقیقه)
    ],

    /**
     * افزودن ثانیه به یک زمان در فرمت HH:MM:SS
     * @param {string} timeString - زمان اولیه
     * @param {number} secondsToAdd - تعداد ثانیه برای افزودن
     * @returns {string} - زمان جدید در فرمت HH:MM:SS
     */
    _addSecondsToTime: function (timeString, secondsToAdd) {
        const [hours, minutes, seconds] = timeString.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, minutes, seconds);
        date.setSeconds(date.getSeconds() + secondsToAdd);

        const newHours = String(date.getHours()).padStart(2, '0');
        const newMinutes = String(date.getMinutes()).padStart(2, '0');
        const newSeconds = String(date.getSeconds()).padStart(2, '0');

        return `${newHours}:${newMinutes}:${newSeconds}`;
    },

    /**
     * ساخت جدول زمانی کامل برای همه ایستگاه‌ها بر اساس زمان حرکت از ایستگاه اول
     * @param {string[]} startTimes - آرایه‌ای از زمان‌های حرکت از ایستگاه مبدأ
     * @param {boolean} reverse - آیا جهت حرکت معکوس است (برای محاسبه زمان‌ها)
     * @returns {Object} - آبجکتی که کلید آن نام ایستگاه و مقدار آن آرایه زمان‌ها است
     */
    _buildSchedule: function (startTimes, reverse = false) {
        const schedule = {};
        const stations = reverse ? [...this.stationNames].reverse() : this.stationNames;
        const travelTimes = reverse ? [...this.stationTravelTimes].reverse() : this.stationTravelTimes;

        let cumulativeTime = 0;

        for (let i = 0; i < stations.length; i++) {
            const stationName = stations[i];
            // زمان توقف در ایستگاه را حدود ۳۰ ثانیه در نظر می‌گیریم (به جز ایستگاه اول)
            if (i > 0) {
                // بر اساس داده‌های اکسل، زمان بین ایستگاه‌ها ثابت نیست
                // از داده‌های travelTimes استفاده می‌کنیم
                cumulativeTime += travelTimes[i];
                // اضافه کردن زمان توقف تقریبی (مثلاً 30 ثانیه)
                if (i < stations.length - 1) { // به جز ایستگاه آخر
                    //cumulativeTime += 30; // این بخش نیاز به تنظیم دقیق‌تر دارد
                }
            }

            // برای ایستگاه اول، زمان‌های ورودی را مستقیم استفاده می‌کنیم
            if (i === 0) {
                schedule[stationName] = startTimes;
            } else {
                // برای ایستگاه‌های بعدی، زمان سفر را به زمان‌های شروع اضافه می‌کنیم
                schedule[stationName] = startTimes.map(startTime => {
                    // اگر زمان شروع *** بود (نشان‌دهنده عدم حرکت)
                    if (startTime === "***" || !startTime) return "***";
                    return this._addSecondsToTime(startTime, cumulativeTime);
                });
            }
        }
        return schedule;
    },

    // تابع کمکی برای محاسبه دقیق‌تر زمان‌ها بر اساس فایل CSV
    // این تابع منطق پیچیده فایل اکسل را شبیه‌سازی می‌کند
    _buildScheduleFromCsvLogic: function (startTimes, reverse = false) {
        const schedule = {};
        const stations = reverse ? [...this.stationNames].reverse() : this.stationNames;

        // زمان‌های سفر تجمعی از ایستگاه مبدأ (بر اساس فایل اکسل)
        // این مقادیر باید با دقت از فایل اکسل استخراج شوند
        const cumulativeTimes = reverse ?
            [0, 120, 180, 240, 300, 360, 420, 480, 540, 600, 660, 840, 960, 1080, 1200, 1320, 1440, 1560] // نور به ائل گؤلی (تخمینی)
            :
            [0, 120, 240, 360, 480, 600, 720, 840, 960, 1080, 1200, 1380, 1500, 1620, 1740, 1860, 1980, 2100]; // ائل گؤلی به نور (تخمینی)

        stations.forEach((stationName, i) => {
            const secondsToAdd = cumulativeTimes[i];
            schedule[stationName] = startTimes.map(startTime => {
                if (startTime === "***" || !startTime) return "***";
                return this._addSecondsToTime(startTime, secondsToAdd);
            });
        });

        return schedule;
    },

    init: function () {
        // ساخت ساختار داده کامل
        this.metroData = {
            normal: {
                toNoor: this._buildScheduleFromCsvLogic(this.elGoliToNoor_Normal, false),
                toElGoli: this._buildScheduleFromCsvLogic(this.noorToElGoli_Normal, true)
            },
            holiday: {
                toNoor: this._buildScheduleFromCsvLogic(this.elGoliToNoor_Holiday, false),
                toElGoli: this._buildScheduleFromCsvLogic(this.noorToElGoli_Holiday, true)
            }
        };

        // حذف داده‌های خام برای تمیزی
        delete this.elGoliToNoor_Normal;
        delete this.noorToElGoli_Normal;
        delete this.elGoliToNoor_Holiday;
        delete this.noorToElGoli_Holiday;
    }
};

// =====================================================================
// ||                          راه‌اندازی سرور                         ||
// =====================================================================

// اجرای تابع init در زمان استارت سرور برای آماده‌سازی داده‌ها
metroDataManager.init();

// تعریف Endpoint اصلی
app.get('/api/schedule', (req, res) => {
    // برگرداندن کل آبجکت JSON زمان‌بندی
    // همچنین لیست نام ایستگاه‌ها را برای راحتی فرانت‌اند اضافه می‌کنیم
    res.json({
        scheduleData: metroDataManager.metroData,
        stationNames: metroDataManager.stationNames
    });
});

app.listen(PORT, () => {
    console.log(`سرور مترو تبریز در آدرس http://localhost:${PORT} در حال اجراست`);
    console.log(`برای دریافت داده‌ها، به http://localhost:${PORT}/api/schedule مراجعه کنید`);
});