/**
 * =====================================================================
 * ||                     ماژول داده‌های مترو (metro-data.js)                     ||
 * =====================================================================
 *
 * این فایل به عنوان "فایل کمکی" عمل می‌کند.
 * وظیفه آن خواندن داده‌های خام زمان‌بندی (شبیه‌سازی شده از CSV)
 * و تبدیل آن‌ها به یک ساختار JSON استاندارد و قابل استفاده برای برنامه است.
 * این کار باعث جداسازی داده‌ها از منطق برنامه (Separation of Concerns) می‌شود.
 */

(function (window) {
    // --- 1. داده‌های خام (شبیه‌سازی شده از فایل‌های CSV شما) ---
    // توجه: من فقط چند ردیف اول و آخر را برای نمونه وارد کرده‌ام.
    // شما باید تمام ردیف‌ها را به همین شکل در اینجا کپی کنید.

    const rawDataNormal = [
        "05:55:00,05:57:00,05:59:00,06:01:00,06:03:00,06:05:00,06:07:00,06:09:00,06:11:00,06:13:00,06:15:00,06:18:00,06:20:00,06:22:00,06:24:00,06:26:00,06:28:00,06:30:00,***,06:50:00,06:48:00,06:46:00,06:44:00,06:42:00,06:40:00,06:38:00,06:36:00,06:34:00,06:32:00,06:29:00,06:27:00,06:25:00,06:23:00,06:21:00,06:19:00,06:17:00,06:15:00",
        "06:10:00,06:12:00,06:14:00,06:16:00,06:18:00,06:20:00,06:22:00,06:24:00,06:26:00,06:28:00,06:30:00,06:33:00,06:35:00,06:37:00,06:39:00,06:41:00,06:43:00,06:45:00,***,07:05:00,07:03:00,07:01:00,06:59:00,06:57:00,06:55:00,06:53:00,06:51:00,06:49:00,06:47:00,06:44:00,06:42:00,06:40:00,06:38:00,06:36:00,06:34:00,06:32:00,06:30:00",
        // ... (سایر ردیف‌های روز عادی اینجا قرار می‌گیرند)
        "19:55:00,19:57:00,19:59:00,20:01:00,20:03:00,20:05:00,20:07:00,20:09:00,20:11:00,20:13:00,20:15:00,20:18:00,20:20:00,20:22:00,20:24:00,20:26:00,20:28:00,20:30:00,***,20:50:00,20:48:00,20:46:00,20:44:00,20:42:00,20:40:00,20:38:00,20:36:00,20:34:00,20:32:00,20:29:00,20:27:00,20:25:00,20:23:00,20:21:00,20:19:00,20:17:00,20:15:00"
    ];

    const rawDataHoliday = [
        "07:30:00,07:32:00,07:34:00,07:36:00,07:38:00,07:40:00,07:42:00,07:44:00,07:46:00,07:48:00,07:50:00,07:53:00,07:55:00,07:57:00,07:59:00,08:01:00,08:03:00,08:05:00,***,08:15:00,08:13:00,08:11:00,08:09:00,08:07:00,08:05:00,08:03:00,08:01:00,07:59:00,07:57:00,07:54:00,07:52:00,07:50:00,07:48:00,07:46:00,07:44:00,07:42:00,07:40:00",
        "07:46:00,07:48:00,07:50:00,07:52:00,07:54:00,07:56:00,07:58:00,08:00:00,08:02:00,08:04:00,08:06:00,08:09:00,08:11:00,08:13:00,08:15:00,08:17:00,08:19:00,08:21:00,***,08:31:00,08:29:00,08:27:00,08:25:00,08:23:00,08:21:00,08:19:00,08:17:00,08:15:00,08:13:00,08:10:00,08:08:00,08:06:00,08:04:00,08:02:00,08:00:00,07:58:00,07:56:00",
        // ... (سایر ردیف‌های روز تعطیل اینجا قرار می‌گیرند)
        "19:46:00,19:48:00,19:50:00,19:52:00,19:54:00,19:56:00,19:58:00,20:00:00,20:02:00,20:04:00,20:06:00,20:09:00,20:11:00,20:13:00,20:15:00,20:17:00,20:19:00,20:21:00,***,20:31:00,20:29:00,20:27:00,20:25:00,20:23:00,20:21:00,20:19:00,20:17:00,20:15:00,20:13:00,20:10:00,20:08:00,20:06:00,20:04:00,20:02:00,20:00:00,19:58:00,19:56:00"
    ];

    // --- 2. لیست ایستگاه‌ها (بر اساس هدر CSV) ---
    // لیست ایستگاه‌ها به ترتیب از ائل گؤلی تا نور
    const allStations = [
        "ائل گؤلی", "سهند", "امام رضا(ع)", "خیام", "29بهمن", "استاد شهریار",
        "دانشگاه", "آبرسان", "سالار ملی(قطب)", "شهید بهشتی (ره)", "میدان ساعت",
        "میدان کهن", "قونقا", "گازران", "لاله", "امام حسین(ع)", "شهید باکری", "نور"
    ];

    // --- 3. تابع پردازشگر (Parser) ---
    /**
     * یک ردیف خام CSV را به دو آبجکت سفر (رفت و برگشت) تبدیل می‌کند.
     * @param {string} rawRow - یک ردیف از داده‌های خام.
     * @param {Array<string>} stations - لیست نام ایستگاه‌ها.
     * @returns {{toNoor: Object, toElGoli: Object}}
     */
    function parseRow(rawRow, stations) {
        const parts = rawRow.split(',');
        if (parts.length < 37) return null; // 18 رفت + 1 جداکننده + 18 برگشت

        const tripToNoor = {};
        const tripToElGoli = {};

        // پردازش سفر به سمت نور (ستون 0 تا 17)
        for (let i = 0; i < stations.length; i++) {
            tripToNoor[stations[i]] = parts[i] || null;
        }

        // پردازش سفر به سمت ائل گؤلی (ستون 19 تا 36)
        // CSV شما برای سفر برگشت هم از هدر "ائل گؤلی ... نور" استفاده کرده
        // پس ما هم بر همان اساس مپ می‌کنیم.
        for (let i = 0; i < stations.length; i++) {
            tripToElGoli[stations[i]] = parts[i + 19] || null;
        }

        return { toNoor: tripToNoor, toElGoli: tripToElGoli };
    }

    // --- 4. ساختار نهایی داده‌ها ---
    /**
     * داده‌های خام را پردازش کرده و در ساختار نهایی قرار می‌دهد.
     * @param {Array<string>} rawData - آرایه‌ای از ردیف‌های خام.
     * @param {Array<string>} stations - لیست ایستگاه‌ها.
     * @returns {{toNoor: Array<Object>, toElGoli: Array<Object>}}
     */
    function processSchedule(rawData, stations) {
        const schedule = {
            toNoor: [],
            toElGoli: []
        };

        rawData.forEach(row => {
            const parsed = parseRow(row, stations);
            if (parsed) {
                schedule.toNoor.push(parsed.toNoor);
                schedule.toElGoli.push(parsed.toElGoli);
            }
        });

        return schedule;
    }

    // --- 5. خروجی نهایی (Export) ---
    // ما داده‌های پردازش شده را در یک متغیر گلوبال قرار می‌دهیم
    // تا فایل index.html بتواند به آن دسترسی داشته باشد.
    window.processedMetroData = {
        stations: allStations,
        schedule: {
            normal: processSchedule(rawDataNormal, allStations),
            holiday: processSchedule(rawDataHoliday, allStations)
        }
    };

})(window);
